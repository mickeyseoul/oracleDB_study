declare

begin
for i in (select salary from members where salary >= 1000) loop
dbms_output.put_line(i.salary);
end loop;

end;
/

▶커서(cursor)
:조회 결과가 두개 이상일 때
--조회결과가 하나일때도 묵시적 커서에 들어갔다가 나오는 것임

declare -- 변수선언 할 것이 없어도 declare써야 함 --cursor 선언하기 때문
	vname members.name%type;
	vsalary members.salary%type;
	vdepart members.depart%type;

cursor sel_cursor is
	select name, salary, depart from members --조회된 결과가 cursor로 들어감
	where salary >= 1000;

begin
	open sel_cursor; --하나씩 가져오는 반복작업
	loop
		fetch sel_cursor into vname, vsalary, vdepart; 
		exit when sel_cursor%NOTFOUND;
		dbms_output.put_line(vname ||','|| vsalary ||','|| vdepart);
	end loop;
	close sel_cursor;

end;
/

1)
book테이블의 모든 레코드의 select no,title, publisher 커서 이용해서 가져오기

declare -- 변수선언 할 것이 없어도 declare써야 함 --cursor 선언하기 때문
	vno book.no%type;
	vtitle book.title%type;
	vpublisher book.publisher%type;

cursor book_cursor is
	select no, title, publisher from book; --조회된 결과가 cursor로 들어감
begin
	open book_cursor; --하나씩 가져오는 반복작업
	loop
	fetch book_cursor into vno, vtitle, vpublisher;
	exit when book_cursor%NOTFOUND;
	dbms_output.put_line(vno ||','|| vtitle ||','|| vpublisher);
	end loop;
	close book_cursor;

end;
/

2)
declare
	i book%rowtype;

cursor book_cursor is
	select no, title, publisher from book;
begin
	--open book_cursor; --PL/SQL: 커서가 이미 열려있습니다
	for i in book_cursor loop
	--exit when book_cursor%notfound;
	dbms_output.put_line(i.no ||','|| i.title ||','|| i.publisher);
	end loop;
	--close book_cursor;

end;
/

-------------------------------------------------------------------------------------
▶예외처리
exception when ~ then ~
no_data_found: 발견된 레코드가 없을 때
too_many_rows: 2줄 이상의 레코드가 조회됐을 때
others: 모든 예외 처리

1)others
declare
	i number;
begin
	i := 6/0;	 --오류: 제수가 0 입니다 --에러발생 바로 exception으로 감
	dbms_output.put_line('i: ' || i); --출력 안됨 -> 바로 예외로 감

	exception when others then	      --others: 모든 예외를 받음
	dbms_output.put_line('오류발생');
end;
/

2)too_many_rows
declare
	vno book.no%type;
	vtitle book.title%type;
begin
	select no, title --오류: 실제 인출은 요구된 것보다 많은 수의 행을 추출합니다
	into vno, vtitle
	from book

	dbms_output.put_line(vno ||','|| vtitle);

	exception
	when too_many_rows then 	    --others>too_many_rows
	dbms_output.put_line('두 줄 이상의 레코드가 있습니다.');
end;
/

3)no_data_found
declare
	vno book.no%type;
	vtitle book.title%type;
begin
	select no, title
	into vno, vtitle
	from book
	where title like '%가%'; --오류: 데이터를 찾을 수 없습니다.

	dbms_output.put_line(vno ||','|| vtitle);

	exception
	when no_data_found then
	dbms_output.put_line('조건에 맞는 레코드가 없습니다.');
	when too_many_rows then 
	dbms_output.put_line('두 줄 이상의 레코드가 있습니다.');
end;
/

연습문제)
name을 입력받기
입력한 이름이 없으면 입력한 이름이 없습니다.
입력한 이름이 두줄있으면 두 줄 이상의 레코드가 있습니다.
하나만 있으면 급여 10% 보너스 출력
id,name,salary,bonus

declare
vid members.id%type;
vname members.name%type := '&name';
vsalary members.salary%type;

begin
	select id, name, salary
	into vid, vname, vsalary
	from members
	where name = vname;

	dbms_output.put_line(vid ||','|| vname ||','|| vsalary ||','|| vsalary*0.1);	

	exception
	when no_data_found then
	dbms_output.put_line('입력한 이름이 없습니다.');
	when too_many_rows then
	dbms_output.put_line('두 줄 이상의 레코드가 있습니다.');
	
end;
/


▷강제로 예외 발생시키기
1)sql에 있는 에러 사용하기

음수가 들어가면 예외가 뜨도록
execute employee_proc(-3,'choi',10); --에러
execute employee_proc(4,'choi',10);

create or replace procedure employee_proc(
					veno employee.eno%type, 
					vename employee.ename%type, 
					vedeptno employee.edeptno%type)
is
--변수선언

begin
	if veno < 0 then
	raise invalid_number; 
	--원래 문자를 숫자로 변환할때 잘못된 경우에 사용 -> 내 맘임 
	--no_data_found 등등도 가능
	end if;

	insert into employee values(veno, vename, vedeptno);

	exception
	when invalid_number then
	dbms_output.put_line('사원번호는 양수만 가능합니다.');
	when others then
	dbms_output.put_line('그 밖의 에러 발생함');
end;
/

2)sql에 없는 에러 만들어 사용하기
create or replace procedure employee_proc(
					veno employee.eno%type, 
					vename employee.ename%type, 
					vedeptno employee.edeptno%type)
is
makeError EXCEPTION; --직접 예외 만듬 원래 없는 에러

begin
	if veno < 0 then
	raise makeError;
	end if;

	insert into employee values(veno, vename, vedeptno);

	exception
	when makeError then
	dbms_output.put_line('사원번호는 양수만 가능합니다.');
	when others then
	dbms_output.put_line('그 밖의 에러 발생함');
end;
/
